---
title: "Missing Data Final Project"
author: "Frank Jiang"
date: "3/13/2020"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set
options(tinytex.verbose = TRUE)
```

Introduction:
Data are collected through the following Kaggle website https://www.kaggle.com/easonlai/sample-insurance-claim-prediction-dataset. It is a sample insurance claim prediction dataset that is based on the medical cost personal dataset. The insurance dataset is collected over health-related variables age, sex, BMI, number of children, whether he is a smoker or not, region, individual medical costs billed by the health insurance, and whether the individual has previously made an insurance claim or not. Age, BMI, number of children, medical bill costs are numerical variables. Sex, smoker or not, and has previous insurance claim are binary variables. The sample size of this dataset is around 1338. The purpose of this analysis is to discover the influence of different variables has on the medical costs of the individual to assist the decision of how much the insurance company should charge to each customer based on their information. 
The datasets are complete, however, to count into the factor of missing data including different imputation methods such as random imputation, mean imputation which will be discussed later in the analysis. Missing data are generated by the following MAR method using the mice package. Missing data are 20% of the dataset. 

Generate missing data
```{r}
library(mice)
Insurance_Data<-read.csv("insurancedata.csv")
#generate missing data from the original dataset
set.seed(953)
Insurance_Data_missing<-ampute(Insurance_Data, prop=0.2)$amp
Insurance_Data_missing<-cbind(Insurance_Data[c(-2,-3,-7)],Insurance_Data_missing[c(2,3,7)])
write.csv(Insurance_Data_missing,"Insurance Data With Missing Value.csv")
```

Main 

In this section, we will use the following imputation method to analyze our dataset. Mean Imputation, Hotdecking, Regression Imputation, Regression Imputation with noise, and multiple regression. Each imputation will be presented with a discussion. A joint table summary will be presented in the summary section. 

Complete Method Analysis

Since we generate the missing data ourselves, when it comes to the complete method, we choose to run the analysis on the whole dataset. 
```{r}
library(ggplot2)
#histogram for the complete data
hist_charges_complete<- ggplot(Insurance_Data,aes(x=charges))+geom_histogram()+labs(x="charges complete")
hist_charges_complete
hist_bmi_complete<- ggplot(Insurance_Data,aes(x=bmi))+geom_histogram()+labs(x="bmi complete")
hist_bmi_complete
#density plot for the complete data
dens_charges_complete<- ggplot(Insurance_Data,aes(x=charges))+geom_density()+labs(x="charges complete")
dens_charges_complete
dens_bmi_complete<- ggplot(Insurance_Data,aes(x=bmi))+geom_density()+labs(x="bmi complete")
dens_bmi_complete

#Regression Analysis for the complete data
reg_complete<- lm(charges~., data=Insurance_Data)
summary(reg_complete)
```

Mean/Mode Imputation

For the charges and BMI variable, we are performing mean imputation to generate data. Basically, what Mean Imputation will do is that it will fill in all missing values for a given variable with the mean of the observed values for that variable. 
```{r}
result1<- mice(Insurance_Data_missing[c(7,8)],method="mean",m=1, maxit=1)
output1<- mice::complete(result1)
Insurance_generated<- cbind(Insurance_Data_missing[c(-7,-8)],output1)
```

For the sex variable, we are perfoming mode imputation to generate data. Basically, what mode imputation will do is that it will fill in all missing values for a given variable with the mode of the observed values for that variable. 
```{r}
mode_num<- function(x){
  ta<- table(x)
  tam<- max(ta)
  if (all(ta==tam))
    mode_num<- NA
  else
    mode_num<- names(ta)[ta==tam]
  return(mode_num)
}

mode.imp<- function(a){
  a.obs<- a[!is.na(a)]
  imputed<- a
  imputed[is.na(a)]<- mode_num(a.obs)
  #output the imputed vector
  return(imputed)
}
Insurance_generated<- mode.imp(Insurance_generated)
```

Then, we will run some descriptive analysis as well as the regression graph based the data we generated. 
```{r}
hist_charges_generated<- ggplot(Insurance_generated,aes(x=charges))+geom_histogram()+labs(x="charges generated")
hist_charges_generated
hist_bmi_generated<- ggplot(Insurance_generated,aes(x=bmi))+geom_histogram()+labs(x="bmi generated")
hist_bmi_generated
dens_charges_generated<- ggplot(Insurance_generated,aes(x=charges))+geom_density()+labs(x="charges generated")
dens_charges_generated
dens_bmi_generated<- ggplot(Insurance_generated,aes(x=bmi))+geom_density()+labs(x="bmi generated")
dens_bmi_generated

#perform regression analysis to the generated missing data
reg_generated<- lm(charges~., data=Insurance_generated)
summary(reg_generated)
```

Regression Imputation
We then use a different imputation method to generate the missing data. Regression Imputation use the complete case sample to build a model that predicts the values of that variable. 
```{r}
#save sex variable
sex<- Insurance_Data$sex
#save original charges variable
original_charges<- Insurance_Data$charges
#charges variable from missing dataset
charges<- Insurance_Data_missing$charges
#create missing data indicator
R_charges<-as.numeric(!is.na(charges)) 

#complete cases
data_complete_var<- Insurance_Data_missing[,1:5]
data_cc<- cbind(data_complete_var,charges)[R_charges==1,]

#remove cases where there is data missing 
data_dropped<- cbind(data_complete_var,charges)[R_charges==0,]

#Regression imputation based on all the complete observed variables
reg_charges<- lm(charges~., data=data.frame(data_cc))

#predict the missing cases from the regression model
charges_imp<- predict(reg_charges,newdata=data.frame(data_dropped))

#Impute the predictions
charges[R_charges==0]<- charges_imp

#calculate SSE
sum((charges-original_charges)^2)
```
```{r}
#save original BMI variable
original_bmi<- Insurance_Data$bmi
#save BMI variable from missing dataset
bmi<- Insurance_Data_missing$bmi
#create missing data indicator
R_bmi<-as.numeric(!is.na(bmi)) 

#complete cases
data_complete_var<- Insurance_Data_missing[,1:5]
data_cc_2<- cbind(data_complete_var,bmi)[R_bmi==1,]

#remove cases where there is data missing 
data_dropped_2<- cbind(data_complete_var,bmi)[R_bmi==0,]

#Regression imputation based on all the complete observed variables
reg_bmi<- lm(bmi~., data=data.frame(data_cc_2))

#predict the missing cases from the regression model
bmi_imp<- predict(reg_bmi,newdata=data.frame(data_dropped_2))

#Impute the predictions
bmi[R_bmi==0]<- bmi_imp

#calculate SSE
sum((bmi-original_bmi)^2)

#Regression Imputation generated data
Insurance_data_reg_imp<- cbind(data_complete_var,sex,charges,bmi)
```

Then, we run the descriptive analysis and regression again to compare the results.
```{r, warning=FALSE}
library(ggplot2)
#histogram for regression imputed variable
hist_charges_reg<- ggplot(Insurance_data_reg_imp,aes(x=charges))+geom_histogram()+labs(x="charges regression imputed")
hist_charges_reg
hist_bmi_reg<- ggplot(Insurance_data_reg_imp,aes(x=bmi))+geom_histogram()+labs(x="bmi regression imputed")
hist_bmi_reg

#density plot for the regression imputed variable
dens_charges_reg<- ggplot(Insurance_data_reg_imp,aes(x=charges))+geom_density()+labs(x="charges regression imputed")
dens_charges_reg
dens_bmi_reg<- ggplot(Insurance_data_reg_imp,aes(x=bmi))+geom_density()+labs(x="bmi regression imputed")
dens_bmi_reg

#Regression analysis for the regression imputed variable.
reg_generated<- lm(charges~., data=Insurance_data_reg_imp)
summary(reg_generated)
```

Regression Imputation With Noise

The following generated data are completed by regression imputation with noise. Comparing to regression Imputation, regression imputation with noise adds back in most of the variability that standard regression imputation removes.

For the BMI and charges variable, we perform regression imputation with noise based on fully observed variables. 
```{r}
#charges variable
#save original charges variable
original_charges<- Insurance_Data$charges

#save missing charges variable
charges<- Insurance_Data_missing$charges

#create missing data indicator
R_charges<-as.numeric(!is.na(charges)) 

#complete cases
data_complete_var<- Insurance_Data_missing[,1:5]
data_cc<- cbind(data_complete_var,charges)[R_charges==1,]

#remove cases where there is data missing 
data_dropped<- cbind(data_complete_var,charges)[R_charges==0,]

#Regression imputation based on all the complete observed variables
reg_charges<- lm(charges~., data=data.frame(data_cc))

#predict the missing cases from the regression model
charges_imp<- predict(reg_charges,newdata=data.frame(data_dropped))

#create noise
charges_noise<- rnorm(length(charges_imp),0,summary(reg_charges)$sigma)

#combine prediction with noise
charges_imps<- charges_imp+charges_noise

#Impute the predictions with noise
charges[R_charges==0]<- charges_imps

#BMI variable
#save original bmi variable
original_bmi<- Insurance_Data$bmi

#save missing bmi variable
bmi<- Insurance_Data_missing$bmi

#create missing data indicator
R_bmi<-as.numeric(!is.na(Insurance_Data_missing$bmi)) 

#complete cases
data_complete_var<- Insurance_Data_missing[,1:5]
data_cc_2<- cbind(data_complete_var,bmi)[R_bmi==1,]

#remove cases where there is data missing 
data_dropped_2<- cbind(data_complete_var,bmi)[R_bmi==0,]

#Regression imputation based on all the complete observed variables
reg_bmi<- lm(bmi~., data=data.frame(data_cc_2))

#predict the missing cases from the regression model
bmi_imp<- predict(reg_bmi,newdata=data.frame(data_dropped_2))

#create noise
bmi_noise<- rnorm(length(bmi_imp),0,summary(reg_bmi)$sigma)

#combine prediction with noise
bmi_imps<- bmi_imp+bmi_noise

#Impute the predictions
bmi[R_bmi==0]<- bmi_imps
```

For the Sex variable, since it is a dichotomous variable, we are going to use logistic regression with noise to generate the missing data.
```{r}
#save missing sex variable
sex<- Insurance_Data_missing$sex

#save original sex variable
original_sex<- Insurance_Data$sex

#create missing data indicator
R_sex<-as.numeric(!is.na(Insurance_Data_missing$sex)) 

#complete cases
data_complete_var<- Insurance_Data_missing[,1:5]
data_cc_3<- cbind(data_complete_var,sex)[R_sex==1,]

#remove cases where there is data missing 
data_dropped_3<- cbind(data_complete_var,sex)[R_sex==0,]

#Regression imputation based on all the complete observed variables
reg_sex<- glm(sex~., data=data.frame(data_cc_3),family = "binomial")

#predict the missing cases from the regression model
sex_ps<- predict(reg_sex,newdata=data.frame(data_dropped_2),type="response")

#create prediction witn noise
sex_imps<- rbinom(sum(R_sex==0),1,sex_ps)

#Impute the predictions
sex[R_sex==0]<- sex_imps

#generated dataset
Insurance_Data_imp<-cbind(data_complete_var,sex,charges,bmi)
```

Similarly, we run the descriptive analysis and regression again to compare the results.
```{r,warning=FALSE}
library(ggplot2)
hist_charges_reg_noise<- ggplot(Insurance_Data_imp,aes(x=charges))+geom_histogram()+labs(x="charges regression imputed with noise")
hist_charges_reg_noise

hist_bmi_reg_noise<- ggplot(Insurance_Data_imp,aes(x=bmi))+geom_histogram()+labs(x="bmi regression imputed with noise")
hist_bmi_reg_noise

dens_charges_reg_noise<- ggplot(Insurance_Data_imp,aes(x=charges))+geom_density()+labs(x="charges regression imputed with noise")
dens_charges_reg_noise

dens_bmi_reg_noise<- ggplot(Insurance_Data_imp,aes(x=bmi))+geom_density()+labs(x="bmi regression imputed with noise")

dens_sex_reg_noise<- ggplot(Insurance_Data_imp,aes(x=sex))+geom_density()+labs(x="sex logistic regression imputed with noise")
dens_sex_reg_noise

#conditional density plot for charges over sex variable distribution
cd_imputed<- cdplot(as.factor(sex)~charges,data=Insurance_Data_imp)
cd_imputed

#perform regression analysis to the generated missing data
reg_generated_noise<- lm(charges~., data=Insurance_Data_imp)
summary(reg_generated_noise)
```

Multiple Imputation

Then, we will perform multiple imputations to generate missing data for our insurance dataset. Multiple imputations, in short, is to perform a simple imputation on a select variable, then replace variable with the prediction from the regression model with each iteration. Multiple imputations will account for the model's uncertainty and sampling uncertainty. 

```{r}
library(mi)
#create missing data frame object
insurance_mdf<- missing_data.frame(Insurance_Data_missing)

#Descriptive Analysis with missing data
summary(insurance_mdf)

#histogram of variable with missing data
hist(insurance_mdf)

#Missing Patterns
#Graph of missing pattern matrix
image(insurance_mdf, grayscale= T)

#std oberserved values with missing
image(insurance_mdf)

#examine default setting
show(insurance_mdf)
```
Run mi with 5 chains and 50 iterations on your dataset with default variable type
```{r}
#run 5 chains with 50 iterations
Insurance_Imputations<- mi(insurance_mdf, n.iter = 50, n.chains = 5)
```

Check convergence/diagnostics and make changes if neccessary
```{r}
#check converagence
insurance_converged<- mi2BUGS(Insurance_Imputations)
head(insurance_converged)

par(mfrow=c(1,1))
#mean bmi
mean_bmi<- insurance_converged[, , 2]
#traceplot of mean bmi
ts.plot(mean_bmi[,1],col=1)
lines(mean_bmi[,2],col=2)
lines(mean_bmi[,3],col=3)
lines(mean_bmi[,4],col=4)
lines(mean_bmi[,5],col=5)

#mean charges
mean_charges<- insurance_converged[, , 3]

#traceplot of mean charges
ts.plot(mean_charges[,1],col=1)
lines(mean_charges[,2],col=2)
lines(mean_charges[,3],col=3)
lines(mean_charges[,4],col=4)
lines(mean_charges[,5],col=5)

#mean sex
mean_sex<- insurance_converged[, , 1]

#check traceplot
ts.plot(mean_sex[,1],col=1)
lines(mean_sex[,2],col=2)
lines(mean_sex[,3],col=3)
lines(mean_sex[,4],col=4)
lines(mean_sex[,5],col=5)

#check R-hat
Rhats(Insurance_Imputations)

#plot diagnostic
#check how model fits
plot(Insurance_Imputations)

#hist
hist(Insurance_Imputations)
```

```{r}
#charge bmi imputation method to pmm
insurance_new<- change(insurance_mdf, y="bmi", what="imputation_method", to="pmm")
insurance_new_imp<- mi(insurance_new, n.iter = 50, n.chains = 5)
#check converagence
insurance_converged<- mi2BUGS(insurance_new_imp)
par(mfrow=c(1,1))
#mean bmi
mean_bmi_new<- insurance_converged[, , 2]
#traceplot of mean bmi
ts.plot(mean_bmi[,1],col=1)
lines(mean_bmi[,2],col=2)
lines(mean_bmi[,3],col=3)
lines(mean_bmi[,4],col=4)
lines(mean_bmi[,5],col=5)
#check rhats
Rhats(insurance_new_imp)
```
From the rhats result, we can conclude that using PMM as imputation method might be better than using PPD

Pool the results and report the estimate equation
```{r}
insurance_analysis_multiple<- pool(charges~ age+children+smoker+region+sex+bmi+insuranceclaim,insurance_new_imp , m=50)
insurance_analysis_multiple
```

Summary
A combined table of the coefficient estimate and the standard error of different imputation method are presented below:

\begin{tabular}{lllll}
                         & Intercept         & age             & children      & smoker          \\
Complete Method          & -10641.61±1010.10 & 256.77±12.37    & 313.39±162.94 & 23090.53±466.93 \\
Regression Imputation    & -11472.09±956.55  & 261.86±11.74    & 272.28±155.00 & 24029.62±443.15 \\
Reg Imputation w/t Noise & -11567.62±963.11  & 263.15±11.94    & 251.96±157.50 & 24260.46±450.45 \\
Multiple Imputation      & -12480.05±1011.02 & 262.56±11.96    & 276.64±159.37 & 24117.10±457.03 \\
                         & region            & insuranceclaim  & sex           & bmi             \\
Complete Method          & -224.28±156.62    & -1073.41±464.69 & 94.42±343.36  & 312.72±32.46    \\
Regression Imputation    & -286.12±148.81    & -1273.09±443.62 & -35.20±325.70 & 339.08±30.94    \\
Reg Imputation w/t Noise & -285.45±151.21    & -1273.03±449.13 & 38.59±331.47  & 339.30±30.97    \\
Multiple Imputation      & -688.20±341.25    & -1368.89±457.51 & -9.94±336.60  & 358.35±32.85   
\end{tabular}

Dicussion

For Mean/Mode imputation:
  Comparing the analysis performed with the imputed data with the complete data, there are some differences in the result. For example, 
the distribution of BMI in the complete data is more likely to be normally distributed. With the imputation data, there is an outstanding density around the mean BMI value. With the complete data, the regression analysis seems to indicate that BMI and charges have a significant impact on the insurance claim, sex and age does not have a large impact on the insurance claim
  However, with the imputed data, it indicates that age is also a significant factor in predicting the insurance claim.

For Regression Imputation
  We can conclude that both the charges and BMI variables using the complete case method are not normally distributed but rather skewed to the left. However, the regression imputed charges and BMI variables are close to normal distribution on each section of the graph. In another word, the imputed values for both the charges and BMI variables always fall right on the regression line. Also, this regression imputation does not include noise. 
From the linear regression result on other variables influence whether an insurance claim was made or not, the regression imputed data exclude the influence of the charges variable. In the complete data, charges have a significant impact on predicting the insurance claim variable. 

For Regression Imputation with Noise
  We can conclude that the charges variable is not normally distributed. However, the BMI variable seems to be normally distributed. For the sex variable, we created a conditional density plot of charges over the sex variable. We can see that the pattern and the correlation of an area of particular charges and genre seem to be identical for the logistic regression imputed with noise method and complete case method. After comparing the regression imputed with the noise graph to the complete cases method graph, we can find that the pattern and distribution seem to be identical, which means that this imputation method is a good way to add back the variability and information when predicting the data. 
From the linear regression result on other variables influence whether an insurance claim was made or not, the variables which have a significant impact on predicting the insurance claim are the same for both models. Comparing complete cases model and regression imputation with noise method, even the coefficient on each variable are similar to each other. Both models show that age, children, whether if it is a smoker or not, charges and BMI has a significant influence on whether a person makes an insurance claim or not. This also proves that adding back the noise with regression imputation is a fairly good technique for generating missing data for analysis purposes. 

For Multiple Imputation
  Comparing to the analysis done by multiple imputations, we can find out that in the multiple imputation method, gender seems to have a less significant impact on the amount that the insurance company charges the customer.
  
General Conclusion:

  Comparing different missing data imputation methods to the complete data analysis, we can quickly discover that mean/mode imputation is a much quicker and easier way to generate data, however, it lacks the variability and the representativeness of the data. Regression Imputation performs better in the representativeness of data. The imputation missing data can be skewed. It fails to count for the variability in the imputation. Also, it tends to become more complicated when there is a lot of data missing. Regression with noise adds back the noise it needs to present the variability in the dataset, however, it still fails to count for the model uncertainty. Multiple Imputation accounts for the model's uncertainty and sampling uncertainty, but it will require a certain amount of computing ability from your statistical software and computer to impute the data and analyze the result. 
